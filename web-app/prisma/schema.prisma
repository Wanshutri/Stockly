datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl"]
}

// =====================================
// Modelos (Tablas)
// =====================================

// --- Tablas base ---

model Marca {
  id_marca     Int        @id @default(autoincrement())
  nombre_marca String     @unique @db.VarChar(100)
  productos    Producto[] // Relación inversa: una marca tiene muchos productos
}

model TipoCategoria {
  id_categoria     Int        @id @default(autoincrement())
  nombre_categoria String     @unique @db.VarChar(100)
  productos        Producto[] // Relación inversa: una categoría tiene muchos productos
}

model TipoUsuario {
  id_tipo     Int       @id @default(autoincrement())
  nombre_tipo String    @db.VarChar(50)
  usuarios    Usuario[] // Relación inversa: un tipo de usuario tiene muchos usuarios
}

model TipoDocumentoTributario {
  codigo_sii String                 @id @db.VarChar(3)
  nombre_tipo String               @db.VarChar(100)
  documentos  DocumentoTributario[] // Relación inversa: un tipo de documento tiene muchos documentos
}

// --- Tablas principales ---

model Producto {
  sku            String           @id @db.VarChar(50)
  nombre         String           @db.VarChar(100)
  id_categoria   Int
  id_marca       Int
  precio_venta   Decimal          @db.Decimal(10, 2)
  precio_compra  Decimal          @db.Decimal(10, 2)
  descripcion    String           @db.VarChar(200)
  stock          Int
  tipo_categoria TipoCategoria    @relation(fields: [id_categoria], references: [id_categoria])
  marca          Marca            @relation(fields: [id_marca], references: [id_marca])
  detalles_compra DetalleCompra[] // Relación inversa: un producto está en muchos detalles de compra
}

model Usuario {
  id_usuario   Int         @id @default(autoincrement())
  nombre       String      @db.VarChar(100)
  email        String      @unique @db.VarChar(100)
  password     String      @db.VarChar(255)
  activo       Boolean     @default(true)
  id_tipo      Int
  tipo_usuario TipoUsuario @relation(fields: [id_tipo], references: [id_tipo])
}

// --- Pagos y Compras ---

model Pago {
  id_pago         Int     @id @default(autoincrement())
  monto_efectivo  Decimal @default(0) @db.Decimal(10, 2)
  monto_tarjeta   Decimal @default(0) @db.Decimal(10, 2)
  compra          Compra? // Relación inversa 1-a-1 con Compra
}

model Compra {
  id_compra             Int                    @id @default(autoincrement())
  fecha                 DateTime               @db.Date
  total                 Decimal                @db.Decimal(10, 2)
  id_pago               Int                    @unique // Clave foránea 1-a-1 para Pago
  pago                  Pago                   @relation(fields: [id_pago], references: [id_pago])
  detalles_compra       DetalleCompra[]        // Relación 1-a-N con DetalleCompra
  documento_tributario DocumentoTributario?    // Relación inversa 1-a-1 con DocumentoTributario
}

// --- Tablas de unión / Detalles ---

model DetalleCompra {
  sku       String   @db.VarChar(50)
  id_compra Int
  cantidad  Int
  subtotal  Decimal  @db.Decimal(10, 2)
  producto  Producto @relation(fields: [sku], references: [sku])
  compra    Compra   @relation(fields: [id_compra], references: [id_compra])

  @@id([sku, id_compra]) // Clave primaria compuesta
}

model DocumentoTributario {
  id_documento Int    @id @default(autoincrement())
  id_compra    Int    @unique // Clave foránea 1-a-1 para Compra
  id_tipo      String @db.VarChar(3)
  compra       Compra @relation(fields: [id_compra], references: [id_compra])
  tipo_documento TipoDocumentoTributario @relation(fields: [id_tipo], references: [codigo_sii])
}
